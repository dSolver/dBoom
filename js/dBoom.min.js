var createContext=function(a){return a.getContext?a.getContext("2d"):!1},eventHandler=function(){$(self.fireButton).mousedown(function(a){a.preventDefault();a.stopPropagation();self.dBall.target();$(self.topborder).show();$(self.leftborder).show();$(self.rightborder).show();$(self.botborder).show();$(self.topborder).fadeOut(300);$(self.leftborder).fadeOut(300);$(self.rightborder).fadeOut(300);$(self.botborder).fadeOut(300)});self.fireButton.ontouchstart=function(a){a.preventDefault();a.stopPropagation();
self.dBall.target();$(self.topborder).show();$(self.leftborder).show();$(self.rightborder).show();$(self.botborder).show();$(self.topborder).fadeOut(300);$(self.leftborder).fadeOut(300);$(self.rightborder).fadeOut(300);$(self.botborder).fadeOut(300)};window.document.addEventListener("keydown",function(a){a.preventDefault();a.stopPropagation();38==a.keyCode?self.ay=4:40==a.keyCode?self.ay=-4:37==a.keyCode?self.ax=-4:39==a.keyCode&&(self.ax=4)},!1);window.document.addEventListener("keyup",function(a){a.preventDefault();
a.stopPropagation();self.ax=0;self.ay=0},!1);window.document.addEventListener("touchmove",function(a){a.preventDefault();a.stopPropagation();window.scroll(0,0);return!1},!1);window.addEventListener("devicemotion",function(a){self.ax=a.accelerationIncludingGravity.x;self.ay=a.accelerationIncludingGravity.y},!0)},mainloop=function(){if(1E4<self.active)self.clearInterval(self.interval),confirm("Are you still there?")&&(self.interval=self.setInterval("mainloop()",self.intervalAmount),self.active=0);else{self.active++;
self.dBall.clear(self.ctx);for(var a in self.goons){var b=self.goons[a];1==b.alive&&b.clear(self.ctx)}for(a in self.goons)b=self.goons[a],1==b.alive?(renderGoons(b),processGoons(b)):0==b.alive&&(b.clear(self.ctx),b.remove(self.goons));self.dBall.process(self.ax,self.ay,self.xmod,self.ymod);self.dBall.draw(self.ctx);3>self.goons.length&&(a=Math.floor(Math.random()*self.spawnZones.length),spawnGoons(self.spawnZones[a]))}},createGoon=function(a,b,c,d,f,e){a={x:a,y:b,degrees:c,speed:d,alive:f,frame:e,
radius:40,id:self.globalGoonCount,happiness:0,turndirection:"",turncount:0,consecutiveturn:0,command:"move",commandLength:0,commandQueue:[],ignoreGoons:0,leniency:30,turn:function(){36<this.consecutiveturn&&(this.leniency-=2);this.turncount>3*this.consecutiveturn&&(this.turndirection=!0==this.turndirection?!1:!0,this.turncount=0);!1==this.turndirection?this.incrementdegrees(self.PI_1_8):!0==this.turndirection?this.incrementdegrees(-self.PI_1_8):this.turndirection=0.5>Math.random()?!0:!1;this.turncount++;
this.consecutiveturn++},face:function(a,b){var c=0;if(a==this.x)c=b==this.y?this.degrees:b>this.y?self.PI:0;else if(b==this.y)c=a>this.x?self.PI_3_2:self.PI_1_2;else{var d=Math.abs(a-this.x),f=Math.abs(b-this.y),d=Math.atan(d/f);a<this.x&&b>this.y?c=d:a<this.x&&b<this.y?c=d+self.PI_1_2:a>this.x&&b<this.y?c=self.PI_3_2-d:a>this.x&&b>this.y&&(c=2*Math.PI-d)}c=alterdegrees(c,0);d=angledifference(alterdegrees(this.degrees,self.PI_1_8),c);f=angledifference(alterdegrees(this.degrees,-self.PI_1_8),c);d<
f?d>self.PI_1_8?this.incrementdegrees(self.PI_1_8):this.degrees=c:f>self.PI_1_8?this.incrementdegrees(-self.PI_1_8):this.degrees=c;return this.degrees==c},move:function(a,b){this.x-=a;this.y+=b;this.consecutiveturn=0;this.leniency=30;for(var c in self.triggerAreas){var d=self.triggerAreas[c];if((Math.abs(d.x-this.x)-30>=d.r?d.r:Math.abs(d.y-this.y)-30>=d.r?d.r:calcDist(this.x,this.y,d.x,d.y)-30)<d.r){switch(d.command){default:(this.goal_x!=d.trigger.x||this.goal_y!=d.trigger.y&&"face"!=this.command)&&
this.addCommand("face",40,d.trigger.x,d.trigger.y)}break}}},incrementdegrees:function(a){this.degrees+=a;0>this.degrees?this.degrees+=360:360<=this.degrees&&(this.degrees-=360)},addCommand:function(a,d,b,c){this.commandQueue.unshift({command:a,commandLength:d,x:b,y:c})},pathCollides:function(a,d,b){var a=this.x-a,d=this.y+d,c=!1;!1==b&&(b=this.leniency,c=collidesGoon(a,d,b,this.id));c||(b=this.leniency,c=collidesObstacle(a,d,b));return c},informCollision:function(a,d){var b=this.x-a,c=this.y+d,f;
for(f in self.goons){var e=self.goons[f];e.x!=this.x&&e.y!=this.y&&calcDist(e.x,e.y,b,c)>this.leniency&&(e.addCommand("wait",200,-1,-1),console.log("waitCount set"))}},clear:function(a){a.clearRect(this.x-30,this.y-30,60,60)},remove:function(a){for(var d in a)a[d].id==this.id&&(a.splice(d,1),this.commandQueue=this.move=this.face=null,this.alive=0,this.clear=this.informCollision=this.pathCollides=null)}};self.globalGoonCount++;return a},createBoomBall=function(a,b,c){return{x:a,y:b,r:c,prev_x:-1,prev_y:-1,
type:1,s_x:0,s_y:0,process:function(a,b){this.prev_x=this.x;this.prev_y=this.y;var c=1.5*b*b*(0>b?-1:1),g=Math.round(this.x+a*a*(0>a?-1:1)),c=Math.round(this.y-c),h=!collidesBorder(g,this.y),i=!collidesBorder(this.x,c);h&&(this.x=g);i&&(this.y=c)},draw:function(a){1==this.type&&(a.beginPath(),a.arc(this.x,this.y,this.r,0,self.PI_2,!1),a.closePath(),a.stroke())},clear:function(a){0<this.prev_x&&0<this.prev_y&&a.clearRect(this.prev_x-this.r-20,this.prev_y-this.r-20,2*this.r+40,2*this.r+40)},target:function(){var a=
getGoonsInArea(this.x,this.y,this.r),b;for(b in a)a[b].alive=0}}},createObstacle=function(a,b,c){return{x:a,y:b,r:c,draw:function(a){a.fillStyle="rgb(255, 0, 0)";a.fillRect(this.x,this.y,1,1);a.beginPath();a.arc(this.x,this.y,this.r,0,self.PI_2,!1);a.lineWidth=1;a.strokeStyle="black";a.closePath();a.stroke()}}},createTrigger=function(a,b,c,d){a={x:a,y:b,r:c,trigger:d,id:self.globalTriggerCount,draw:function(a){a.fillStyle="rgb(255, 0, 0)";a.fillRect(this.x,this.y,1,1);a.beginPath();a.arc(this.x,this.y,
this.r,0,self.PI_2,!1);a.lineWidth=1;a.strokeStyle="blue";a.closePath();a.stroke()}};self.globalTriggerCount++;return a},createSpawnZone=function(a,b,c){a={x:a,y:b,r:c,x1:a-c,y1:b-c,x2:a+c,y2:b+c,id:self.globalSpawnZoneCount,draw:function(a){a.fillStyle="rgba(20, 30, 255, 0.2)";a.beginPath();a.arc(this.x,this.y,this.r,0,self.PI_2,!1);a.closePath();a.fill()},pointIn:function(a,b){return calcDist(a,b,this.x,this.y)<=this.r?!0:!1}};self.globalSpawnZoneCount++;return a},angledifference=function(a,b){var c=
Math.abs(b-a);c>Math.PI&&(c=2*Math.PI-c);return c},alterdegrees=function(a,b){var c=a+b;if(c>=2*Math.PI)c%=2*Math.PI;else if(0>c)for(;0>c;)c+=2*Math.PI;return c},calcDist=function(a,b,c,d){a=c-a;b=d-b;return Math.sqrt(a*a+b*b)},posConflict=function(a,b){var c=!1,d;for(d in self.goons){var f=self.goons[d],e=Math.abs(a-f.x),g=Math.abs(b-f.y);e>=f.leniency||g>=f.leniency||Math.sqrt(e*e+g*g)<f.leniency&&(c=!0);if(!0==c)break}c||(c=collidesObstacle(a,b,60));return c},collidesBorder=function(a,b){return 50>
a||a>this.canvasWidth-50||50>b||b>this.canvasHeight-50?!0:!1},collidesObstacle=function(a,b,c){var d=!1,d=collidesBorder(a,b);if(!d)for(var f in this.obstacles){var e=this.obstacles[f],g=Math.abs(a-e.x),h=Math.abs(b-e.y);g>=c+e.r||h>=c+e.r||calcDist(e.x,e.y,a,b)-e.r<c+e.r&&(d=!0);if(!0==d)break}return d},collidesGoon=function(a,b,c,d){var f=!1,e;for(e in this.goons){var g=this.goons[e];if(g.id!=d){var h=Math.abs(g.x-a),i=Math.abs(g.y-b);if(!(h>=c||i>=c)&&calcDist(g.x,g.y,a,b)<c){f=!0;break}if(!0==
f)break}}return f},getGoonsInArea=function(a,b,c){var d=[],f;for(f in this.goons){var e=this.goons[f],g=Math.abs(e.x-a),h=Math.abs(e.y-b);g>=c||h>=c||calcDist(e.x,e.y,a,b)<c&&d.push(e)}return d},renderGoons=function(a){var b=self.goonSize;self.ctx.save();self.ctx.translate(a.x,a.y);self.ctx.rotate(a.degrees);self.spriteSet[a.frame]?self.ctx.drawImage(self.spriteSet[a.frame],-b/2,-b/2):console.log("invalid: "+a.frame);self.ctx.restore()},processGoons=function(a){if(0<a.commandLength&&"move"!=a.command){if("face"==
a.command)a.face(a.goal_x,a.goal_y)?a.commandLength=0:a.face(a.goal_x,a.goal_y);else if("attack"!=a.command&&"wait"!=a.command&&"stepBack"==a.command){var b=-Math.round(Math.sin(a.degrees)*a.speed/2),c=-Math.round(Math.cos(a.degrees)*a.speed/2);a.pathCollides(b,c,0<a.ignoreGoons,a.leniency)?a.turn():a.move(b,c);a.frame=(a.frame+1)%24}a.commandLength--}else 0<a.commandQueue.length?(b=a.commandQueue.pop(),a.command=b.command,a.commandLength=b.commandLength,0<b.x&&0<b.y&&(a.goal_x=b.x,a.goal_y=b.y)):
a.addCommand("move",0,-1,-1),"move"==a.command&&(b=Math.round(Math.sin(a.degrees)*a.speed/2),c=Math.round(Math.cos(a.degrees)*a.speed/2),a.pathCollides(b,c,0<a.ignoreGoons,a.leniency)?a.turn():a.move(b,c),0<a.ignoreGoons&&a.ignoreGoons--,a.frame=(a.frame+1)%24)},spawnGoons=function(a){for(var b=Date.parse(new Date),c=0;10>c;c++){for(var d=Math.random(),f=Math.random(),e=Math.round(2*d*a.r)+a.x1,g=Math.round(2*f*a.r)+a.y1,f=Math.round((d+f)*Math.PI),d=Math.round(23*d),h=!1,i=0;!h&&8>i;)e=Math.round(2*
Math.random()*a.r)+a.x1,g=Math.round(2*Math.random()*a.r)+a.y1,h=!posConflict(e,g),i++;8<=i||(e=createGoon(e,g,f,3,1,d),self.goons.push(e))}a=Date.parse(new Date);console.log(a-b)},run=function(){eventHandler(this.canvas);this.interval=this.setInterval("mainloop()",this.intervalAmount)},dBoom=function(){this.canvas=document.getElementById("dCanvas");this.txtdiv=document.getElementById("dTextDiv");this.fireButton=document.getElementById("dFireButton");this.fireImg1=document.getElementById("fire_button");
this.fireImg2=document.getElementById("fire_button2");this.topborder=$("#dTopBorder");this.leftborder=$("#dLeftBorder");this.rightborder=$("#dRightBorder");this.botborder=$("#dBotBorder");this.ctx=createContext(this.canvas);this.spriteSet=[];this.goonSize=40;this.active=0;this.intervalAmount=50;this.canvasWidth=1024;this.canvasHeight=600;this.ymod=this.xmod=this.ay=this.ax=this.globalTileCount=this.globalSpawnZoneCount=this.globalTriggerCount=this.globalGoonCount=0;this.PI_1_8=Math.PI/8;this.PI_1_4=
Math.PI/4;this.PI_3_2=3*Math.PI/2;this.PI_2=2*Math.PI;this.PI=Math.PI;for(var a=0;24>a;a++)this.spriteSet[a]=new Image,this.spriteSet[a].src="img/skeleton_archer/s_a_move_torso_00"+(5>a?"0":"")+2*a+".png";this.dBall=createBoomBall(400,250,30);this.goons=[];this.obstacles=[];this.triggerAreas=[];this.spawnZones=[];this.obstacles.push(createObstacle(289,297,40));this.obstacles.push(createObstacle(304,262,39));this.obstacles.push(createObstacle(313,186,36));this.obstacles.push(createObstacle(288,119,
37));this.obstacles.push(createObstacle(263,77,45));this.obstacles.push(createObstacle(300,153,38));this.obstacles.push(createObstacle(312,30,40));this.obstacles.push(createObstacle(308,227,36));this.obstacles.push(createObstacle(360,8,25));this.obstacles.push(createObstacle(40,193,60));this.obstacles.push(createObstacle(22,262,57));this.obstacles.push(createObstacle(7,581,55));this.obstacles.push(createObstacle(562,163,41));this.obstacles.push(createObstacle(522,197,23));this.obstacles.push(createObstacle(645,
151,55));this.obstacles.push(createObstacle(687,91,55));this.obstacles.push(createObstacle(674,219,35));this.obstacles.push(createObstacle(682,27,27));this.obstacles.push(createObstacle(968,387,68));this.obstacles.push(createObstacle(998,279,45));this.obstacles.push(createObstacle(963,488,72));this.obstacles.push(createObstacle(956,591,95));this.obstacles.push(createObstacle(1012,225,50));this.triggerAreas.push(createTrigger(51,70,20,{command:"face",x:132,y:57}));this.triggerAreas.push(createTrigger(172,
65,20,{command:"face",x:177,y:191}));this.triggerAreas.push(createTrigger(177,191,40,{command:"face",x:137,y:404}));this.triggerAreas.push(createTrigger(137,404,25,{command:"face",x:317,y:550}));this.triggerAreas.push(createTrigger(859,0,85,{command:"face",x:797,y:332}));this.triggerAreas.push(createTrigger(868,159,25,{command:"face",x:797,y:332}));this.triggerAreas.push(createTrigger(742,147,15,{command:"face",x:797,y:332}));this.triggerAreas.push(createTrigger(797,332,25,{command:"face",x:625,y:306}));
this.spawnZones.push(createSpawnZone(115,81,60));this.spawnZones.push(createSpawnZone(477,63,70));this.spawnZones.push(createSpawnZone(849,152,70));a=this.spawnZones[Math.floor(Math.random()*this.spawnZones.length)];spawnGoons(a);setTimeout("run()",100)},restart=function(){console.log("resetting");this.ctx.clearRect(0,0,800,500);this.clearInterval(this.interval);dBoom()};window.onload=function(){dBoom();$("#reset_button").click(function(){restart()})};